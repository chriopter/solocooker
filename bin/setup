#!/usr/bin/env bash
set -eo pipefail

REDIS_PORT=6379
REDIS_HOST="localhost"

if [ "$RAILS_ENV" = "production" ]; then
  echo "RAILS_ENV is production; bailing out"
  exit 1
fi

# Check if gum is installed for nice output
if ! command -v gum &> /dev/null; then
  if command -v pacman &> /dev/null; then
    sudo pacman -S --noconfirm --needed gum
  elif command -v brew &> /dev/null; then
    brew install gum
  else
    echo "Please install gum for better output: https://github.com/charmbracelet/gum"
  fi
fi

step() {
  if command -v gum &> /dev/null; then
    gum style --foreground 212 "→ $1"
  else
    echo "→ $1"
  fi
}

redis_running() {
  (echo > /dev/tcp/$REDIS_HOST/$REDIS_PORT) 2>/dev/null
}

step "Installing dependencies"

if command -v brew &> /dev/null; then
  brew install sqlite ffmpeg mise
elif command -v pacman &> /dev/null; then
  sudo pacman -S --noconfirm --needed sqlite ffmpeg mise
elif command -v apt &> /dev/null; then
  sudo apt-get install --no-install-recommends -y libsqlite3-0 ffmpeg
fi

if command -v mise &> /dev/null; then
  step "Installing Ruby via mise"
  mise install
else
  echo "Couldn't install mise"
  echo "Install mise using your package manager or via:"
  echo "https://mise.jdx.dev/installing-mise.html"
  exit 1
fi

step "Installing gems"
bundle check || bundle install

step "Preparing database"
if [[ " $* " == *" --reset "* ]]; then
  rm -rf ./storage/{db,files}
  bin/rails db:reset
fi
bin/rails db:prepare

if ! redis_running; then
  step "Starting Redis"
  if command -v docker &> /dev/null; then
    if docker ps -a --format '{{.Names}}' | grep -q '^campfire-redis$'; then
      docker start campfire-redis
    else
      docker run -d --name campfire-redis -p $REDIS_PORT:$REDIS_PORT redis:7
    fi
  else
    echo "Couldn't start Redis"
    echo "Install either docker or redis and then run this command again"
    exit 1
  fi
fi

step "Removing old logs and tempfiles"
bin/rails log:clear tmp:clear

step "Restarting services"
bin/rails restart

echo ""
if command -v gum &> /dev/null; then
  gum style --foreground 40 "✓ Setup complete!"
else
  echo "✓ Setup complete!"
fi
